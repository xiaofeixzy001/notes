[TOC]

并发&并行&进程&线程

# 概念

## 并发

concurrency，同时做某些事，但是强调，一个时段内有事情要处理。

## 并行

同时做某些事，可以互不干扰的同一个时刻做几件事。

## 生活示例

中午12点开饭，大家都涌向食堂，这是并发，如果人很多，就是高并发。

食堂同时开放20个打饭窗口，这是并行。

无论是并行还是并发，在用户看来都是'同时'运行的，不管是进程还是线程，都只是一个任务而已，真是干活的是cpu，cpu来做这些任务，而一个cpu同一时刻只能执行

一个任务..

并行：同时运行，只有具备多个cpu才能实现并行

并发：是伪并行，即看起来是同时运行。单个cpu+多道技术就可以实现并发，（并行也属于并发）

# 并发的解决

## 队列&缓冲区

如果食堂只开放1个窗口，排队打饭是比较好的方式。所以队列是一种天然解决并发的办法，

队列，先进先出，解决了资源使用问题，排成的队列其实就是一个缓冲地带，叫缓冲区。

假如提供女生优先打饭,女生队伍就是一个优先队列。

常见队列：Queue，LifoQueue，PriorityQueue

## 争抢

只开一个窗口，没有队列时，谁挤到前面就给谁打饭，打饭的人占据窗口，直到打完离开。

其他人继续争抢，会有一个人占据窗口，可以视为锁定窗口，此时窗口不能为其他人提供服务了，这是一种锁机制，谁抢到资源就上锁，排他性的锁，其他人只能等候。

争抢也是一种高并发解决方案，但是这样不好，因为有可能有人很长时间抢不到。

## 预处理

如果排长队的原因，是由于打的饭量少，要现做，没打着饭不走开，锁定着窗口。

食堂可以提前统计大多数人最爱吃的菜品，提前做好，保证供应。

一种提前加载用户需要的数据的思路，预处理思想，缓存常用。

# 并行的处理

成百上千人同时来吃饭，多开几个窗口形成多个队列。

日常可通过购买更多服务器,或多开进程、线程实现并行处理，解决并发问题，这些都是水平扩展思想。

注意，如果线程在单CPU上处理，就不是并行了，但多数服务器都是多CPU的，服务的部署也往往都是多机的、分布式的，都是并行处理。

## 提速

提高单个窗口的打饭速度，也是解决并发的方式。

提高单个CPU性能或单个服务器安装更多CPU，这是垂直扩展思想。

# 消息中间件

地铁站进站口外的九曲回肠的走廊，缓冲人流，进去之后在多口安检进站。

常见消息中间件有RabbitMQ, ActiveMQ(Apache), RocketMQ(阿里Apache), kafka(Apache)等。

一般来说不同并发场景用不同的策略，而策略可能是多种方式的优化组合。

例如：

多开食堂(多地)

把食堂建设到宿舍生活区(就近)

所以说，技术源于生活。

# 扩展

## 多道技术

多道技术：内存中同时存入多道（多个）程序，cpu从一个进程快速切换到另外一个，使每个进程各自运行几十或几百毫秒，这样，虽然在某一个瞬间，一个cpu只能执行

一个任务，但在1秒内，cpu却可以运行多个进程，这就给人产生了并行的错觉，即伪并发，以此来区分多处理器操作系统的真正硬件并行（多个cpu共享同一个物理内存）

## 同步与异步

同步就是指一个进程在执行某个请求的时候，若该请求需要一段时间才能返回信息，那么这个进程将会一直等待下去，直到收到返回信息才继续执行下去；

异步是指进程不需要一直等下去，而是继续执行下面的操作，不管其他进程的状态。当有消息返回时系统会通知进程进行处理，这样可以提高执行的效率。

举个例子，打电话时就是同步通信，发短息时就是异步通信。

# **进程**

Process,是计算机中的程序关于某数据集合上的一次运行活动，是系统进行资源分配和调度的基本单位，是操作系统结构的基础。

正在进行的一个过程或者说一个任务,而负责执行任务则是cpu.

程序并不能单独运行，只有将程序装载到内存中，系统为它分配资源才能运行，而这种执行的程序就称之为进程。

程序和进程的区别就在于：程序是指令的集合，它是进程运行的静态描述文本；进程是程序的一次执行活动，属于动态概念。

在多道编程中，我们允许多个程序同时加载到内存中，在操作系统的调度下，可以实现并发地执行。这是这样的设计，大大提高了CPU的利用率。进程的出现让每个用户感觉到自己独享CPU，因此，进程就是为了在CPU上实现多道编程而提出的。

例如:

某人在一天内有很多任务要做:备课,写书,陪女友,但同一时刻只能做一个任务(CPU同一时间只能干一个活),这就是进程..

先备一会课,写一会书,陪一会女友,保证了每个任务都在进行中,这就是进程的执行与切换.

# **进程的创建**

新进程的创建都是由一个已经存在的进程执行了一个用于创建进程的系统调用而创建的：

1,在UNIX中该系统调用是：fork，fork会创建一个与父进程一模一样的副本，二者有相同的存储映像、同样的环境字符串和同样的打开文件（在shell解释器进程中，执行一个命令就会创建一个子进程）；

2,在windows中该系统调用是：CreateProcess，CreateProcess 既处理进程的创建，也负责把正确的程序装入新进程。

## 区别

Linux进程有父进程和子进程，Win的进程是平等关系。

1,相同的是：进程创建后，父进程和子进程有各自不同的地址空间（多道技术要求物理层面实现进程之间内存的隔离），任何一个进程的在其地址空间中的修改都不会影响到另外一个进程。

2,不同的是：在UNIX中，子进程的初始地址空间是父进程的一个副本，提示：子进程和父进程是可以有只读的共享内存区的。但是对于windows系统来说，从一开始父进程与子进程的地址空间就是不同的。

# **进程的终止**

1,正常退出（自愿，如用户点击交互式页面的叉号，或程序执行完毕调用发起系统调用正常退出，在linux中用exit，在windows中用ExitProcess）

2,出错退出（自愿，执行命令"python a.py"中a.py不存在）

3,严重错误（非自愿，执行非法指令，如引用不存在的内存，1/0等，可以捕捉异常，try...except...）

4,被其他进程杀死（非自愿，如kill -9）

# **线程**

有时被称为轻量级进程(Lightweight Process, LWP),是程序执行流的最小单元。

线程是操作系统能够进行运算调度的最小单位。它被包含在进程之中，是进程中的实际运作单位。一条线程指的是进程中一个单一顺序的控制流，一个进程中可以并发多个线程，每条线程并行执行不同的任务.

## 进程线程理解

每一个进程都认为自己独占所有的计算机硬件资源，进程就是独立的王国，进程间不可以随便的共享数据。

线程就是省份，同一个进程内的线程可以共享进程的资源，每一个线程拥有自己独立的堆栈。

例如:

一个操作系统就像是一个工厂，工厂里面有很多个生产车间，不同的车间生产不同的产品，每个车间就相当于一个进程，且你的工厂又穷，供电不足，同一时间只能给一个车间供电，为了能让所有车间都能同时生产，你的工厂的电工只能给不同的车间分时供电，但是轮到你的qq车间时，发现只有一个干活的工人，结果生产效率极低，为了解决这个问题，应该怎么办呢？没错，你肯定想到了，就是多加几个工人，让几个人工人并行工作，这每个工人，就是线程！

## **多线程**

即多个控制线程,概念是在一个进程中存在多个控制线程，多个控制线程共享该进程的地址空间.

进程只是用来把资源集中到一起（进程只是一个资源单位，或者说资源集合），而线程才是cpu上的执行单位，

例如，北京地铁与上海地铁是不同的进程，而北京地铁里的13号线是一个线程，北京地铁所有的线路共享北京地铁所有的资源，比如所有的乘客可以被所有线路拉。

多线程指的是，在一个进程中开启多个线程，简单的讲：如果多个任务共用一块地址空间，那么必须在一个进程内开启多个线程。详细的讲分为4点：

1,多线程共享一个进程的地址空间

2,线程比进程更轻量级，线程比进程更容易创建可撤销，在许多操作系统中，创建一个线程比创建一个进程要快10-100倍，在有大量线程需要动态和快速修改时，这一特

性很有用

3,若多个线程都是cpu密集型的，那么并不能获得性能上的增强，但是如果存在大量的计算和大量的I/O处理，拥有多个线程允许这些活动彼此重叠运行，从而会加快程序

执行的速度。

4,在多cpu系统中，为了最大限度的利用多核，可以开启多个线程（比开进程开销要小的多）

## 线程状态

### 就绪

Ready，线程能够运行，但是等待被调度。可能线程刚刚创建启动，或刚刚从阻塞中恢复，或者被其他线程抢占。

### 运行

Running，线程正在运行

### 阻塞

Blocked，线程等待外部事件发生而无法运行，如I/O操作。

### 终止

Terminated，线程完成或退出或被取消。

![img](%E8%BF%9B%E7%A8%8B%E7%BA%BF%E7%A8%8B%E7%90%86%E8%AE%BA%E5%9F%BA%E7%A1%80.assets/ec7be8e7-1d11-4f31-bd15-21b9bf9f0006.jpg)



